TopSideMonitor: fish behavior recording and tracking
====================================================

TopSideMonitor is a python program for recording and analyzing adult zebrafish behavior developed for our study ["Rapid olfactory discrimination learning in adult zebrafish", Namekawa et al (2018), Experimental Brain Research](https://rdcu.be/4bM2). TopSideMonitor uses two orthogonal webcams (Top and Side views) to track fish in 3D and extract various parameters (xyz trajectory, swimming speed, water surface sampling, distance to a point of interest etc) useful to characterize fish behaviors.

# Installation

Tested on Python 2.7 series on Windows 7/10. 

Install dependencies: numpy, scipy, wxpython (v2.8.12), opencv (v2.4.11), matplotlib, xlrd, xlwt.

This can be done by miniconda commands below:

```
conda create -n topside27 python=2.7 scipy matplotlib xlrd xlwt

conda install -c krisvanneste wxpython

conda install -c menpo opencv
```

Copy some reasonably new ffmpeg.exe binary into resourse folder.

(Optional)
For a FireWire camera, install motmot.cam_iface from http://code.astraw.com/projects/motmot/.

Once installed, activate the conda environment by `conda activate topside27` from Anaconda prompt and then start the script by `python TopSideMonitor_FrontEnd.py` for recording and by `python multitrack.py for analysis`.


# How to use

* TopSideMonitor_FrontEnd.py

  - This is the GUI frontend for recording fish behavior. Run this script to set the recording parameters in GUI and press [Launch] button to open two camera frame viewers.
   
  - With one of two frame viewers clicked, use keyboard shortcuts to control video acquisition. First, press [T] to preview foreground image to optimize the webcam setting (exposure, contrast, etc) and lighting. Once nice & stable fish foreground is obtained, press [T] again to come back to raw frame view. Now, press [R] to start the recording and [R] again to stop. You can set a fix amount of time or frames to record in the GUI as well. [ECS] will close and exit from the viewer.


* multitrack.py

   This is for analysing the video generated by TopSideMonitor_FrontEnd.py. It tracks fish with a simple background subtraction method (opencv MOG) and produce 3D fish trajectory data as well as various parameters useful to characterize feeding behavior.
     
     Tracking
       1. Open a video file from Menu File -> Open or just drag and drop the video file.
       2. Register a fish name (eg. GCaMP6_fish01) and [Register fish/Save] and choose it from the pull down menu on right. You can use [Remove] button to remove the wrong/unnecessary entries.
       3. Once a fish is selected from pull down menu, set the TopView ROI by adjusting parameters with TV prefix (TopView). Repeat this for Side View.
       4. If more than one fish is in the video, you can repeat Step 2 and 3 to regisrer more fish.
       5. Press [Play/Track] to start tracking.
       6. Once tracking is done, you can go back and forth the frames and manually correct the tracking data if needed.
       7. Once good tracking is obtained, press [Register fish/Save] to save the tracking data.

    Analyzing olfactory conditioning behavior

       1. Register events either using the GUI (not recommended) or by preparing an excel sheet. First collumn is the fish name, 2nd collumn is the event label, and 3rd collumn is the event frame number (refer to example_event_sheet.xlsx) and drag and drop an excel file to overwrite the event data.
       2. Menu Analysis -> Create PDF report to get a PDF summary of this analysis and npz or mat file containing tracking data and analysis results.


License
=======

TopSideMonitor is licensed under a 3-clause BSD style license - see the LICENSE.txt file.
